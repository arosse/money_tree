<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Simulation Dashboard</title>
    <link rel="stylesheet" href="style.css">
	<style>
        /* Simple spinner styling */
        .spinner {
            border: 6px solid rgba(0, 0, 0, 0.1);
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
		
		.plotly-graph {
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
	
</head>
<body>
    <header>
        <h1>Dashboard</h1>
    </header>

    <main>
        <section id="data-section">
            <h2>Current Data</h2>
            <p id="data-value">Loading data...</p>
            <button onclick="refreshData()">Refresh Data</button>
			<br><br>
        </section>

        <section id="chart-section">
            <h2>Data 01</h2>
			<div id="plotly-graph-1" class="plotly-graph">
				<div class="spinner"></div>
			</div>
        
			<h2>Data 02</h2>
			<div id="plotly-graph-2" class="plotly-graph">
				<div class="spinner"></div>
			</div>
			
			<h2>Data 03</h2>
			<div id="plotly-graph-3" class="plotly-graph">
				<div class="spinner"></div>
			</div>
        </section>
		
    </main>


    <footer>
        <p>Footer Text</p>
    </footer>
	
	<!-- Plotly scripts -->
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
	
	<!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.19.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.0/firebase-database.js" type="module"></script>

	<script type="module">			
		// Your web app's Firebase configuration
		const firebaseConfig = {
			apiKey: "AIzaSyDOUk81nMwiwiT8nNI9iX8E6N59ZCepSFg",
			authDomain: "money-tree-25168.firebaseapp.com",
			databaseURL: "https://money-tree-25168-default-rtdb.europe-west1.firebasedatabase.app",
			projectId: "money-tree-25168",
			storageBucket: "money-tree-25168.firebasestorage.app",
			messagingSenderId: "605722075398",
			appId: "1:605722075398:web:1bf1462b8293ec50837e87"
		};
		
		// Import necessary functions from Firebase SDK
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.0/firebase-app.js";
		import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.19.0/firebase-database.js";
		
		// Initialize Firebase
		const app = initializeApp(firebaseConfig);
		const db = getDatabase(app);  // Initialize the database

		// Function to fetch the JSON data from Google Drive
        function fetchData() {
			document.getElementById('data-value').textContent = "Loading data...";
            setLoadingState(true);
			
			// add test delay
			delay(1000);
			
			// Get reference to root or specific path
            const dbRef = ref(getDatabase(), '/');  // Path to data in Firebase (fetching entire data object)
			
			get(dbRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();  // Get the whole data object from Firebase
                    setLoadingState(false);
                    document.getElementById('data-value').textContent = "Data loaded successfully.";
                    updateGraphs(data);  // Pass the entire data object to updateGraphs()
                } else {
                    console.log("No data available");
                    document.getElementById('data-value').textContent = "Failed to load data.";
                    setLoadingState(false);
                }
            }).catch((error) => {
                console.error("Error fetching data from Firebase:", error);
                document.getElementById('data-value').textContent = "Failed to load data.";
                setLoadingState(false);
            });
        }
		
		// Function to set the loading state for graphs
        function setLoadingState(isLoading) {
            const graphs = document.querySelectorAll('.plotly-graph');
            graphs.forEach((graph) => {
                if (isLoading) {
                    graph.innerHTML = '<div class="spinner"></div>';
                } else {
                    graph.innerHTML = '';
                }
            });
        }
		
		// Function to update the graphs with the new data
        function updateGraphs(data) {
            const graphData = [
                { x: data.x1, y: data.y1, title: "Data 01" },
                { x: data.x2, y: data.y2, title: "Data 02" },
                { x: data.x3, y: data.y3, title: "Data 03" }
            ];

            // Reusable layout and config for Plotly
            const layout = {
                margin: {
                    t: 10,  // Top margin
                    r: 15,  // Right margin
                    b: 30,  // Bottom margin
                    l: 30   // Left margin
                }
            };

            const config = {
                modeBarButtonsToRemove: ['toImage', 'select2d', 'lasso2d', 'hoverClosestCartesian', 'toggleSpikelines', 'hoverCompareCartesian'],
                displaylogo: false
            };

            // Function to initialize each Plotly graph
            function initPlotlyGraph(elementId, dataX, dataY) {
                const trace = {
                    x: dataX,
                    y: dataY,
                    type: 'scatter'
                };
                Plotly.newPlot(elementId, [trace], layout, config);
            }

            // Loop through each graph and initialize it
            graphData.forEach((data, index) => {
                initPlotlyGraph(`plotly-graph-${index + 1}`, data.x, data.y);
            });
        }
		
		// Refresh data manually
        function refreshData() {
            fetchData();
        }

        // Load Firebase client and fetch data
        window.onload = fetchData;
		
    </script>

</body>
</html>